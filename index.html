<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Calculatrice Dividendes</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
  :root{
    --bg:#faf7fb; --card:#fff; --ink:#1f1b24; --muted:#6a6873;
    --border:#eadcec; --brand:#b40f67; --accent:#079455; --soft:#fff4fb; --soft-border:#ffd2ef; --tile:#f7f2f7;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#151218; --card:#1d1923; --ink:#f6eef8; --muted:#bdb7c4;
      --border:#3a3241; --brand:#db3e8e; --accent:#41d59b; --soft:#2a2130; --soft-border:#3c2a35; --tile:#241f2a;
    }
  }
  [data-theme="dark"]{
    --bg:#151218; --card:#1d1923; --ink:#f6eef8; --muted:#bdb7c4;
    --border:#3a3241; --brand:#db3e8e; --accent:#41d59b; --soft:#2a2130; --soft-border:#3c2a35; --tile:#241f2a;
  }
  *{box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:28px auto;padding:0 16px}
  .toolbar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:8px}
  .btn-sm{padding:8px 10px;border:1px solid var(--border);background:var(--card);color:var(--ink);
          border-radius:10px;cursor:pointer;font-weight:600}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  h1{color:#5b2550;margin:0 0 12px;font-weight:800}
  [data-theme="dark"] h1{color:#f1d3ea}
  .label{font-size:16px;font-weight:700;color:var(--ink);margin:16px 4px 8px}
  input,select{width:100%;padding:14px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:var(--card);color:var(--ink)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{margin-top:16px;width:100%;padding:14px;border:0;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;font-size:18px;cursor:pointer}
  .pill{margin-top:16px;background:var(--soft);border:1px solid var(--soft-border);border-radius:12px;padding:16px;text-align:center}
  .yield{font-size:32px;font-weight:900;color:var(--accent)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
  .kpi{background:var(--tile);border:1px solid var(--border);border-radius:12px;padding:12px}
  .kpi small{color:var(--muted)}
  .kpi b{display:block;font-size:18px;margin-top:4px}
  .inline{display:grid;grid-template-columns: 1fr 110px 100px;gap:8px;align-items:center}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .foot{margin:12px 0;color:var(--muted);font-size:12px;text-align:center}
  .actions{display:flex;gap:10px;margin-top:16px}
  .btn-outline{flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--ink);font-weight:700;cursor:pointer}
  .chk{display:flex;align-items:center;gap:8px;font-size:14px;color:var(--muted);flex-wrap:wrap;line-height:1.4;margin-top:6px}
  .chk label{flex:1}
  .badge{display:inline-block;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  @media print{ .toolbar,.btn,.actions{display:none!important} .wrap{margin:0;padding:0} .card{border:none;box-shadow:none} }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button class="btn-sm" id="themeToggle">üåô/‚òÄÔ∏è</button>
    <button class="btn-sm" id="printBtn">üñ®Ô∏è Exporter PDF</button>
  </div>

  <div class="card">
    <h1>Dividend Calculator</h1>

    <!-- Ticker -->
    <div class="row">
      <div>
        <div class="label">Ticker (ex: AAPL, NOVO-B.CO)</div>
        <input id="ticker" placeholder="ex: AAPL">
        <div class="hint">Utilis√© pour r√©cup√©rer ex-date, payment date, montant (via API).</div>
      </div>
      <div>
        <div class="label">Prochain dividende (API)</div>
        <div class="inline">
          <button class="btn" id="fetchDiv">R√©cup√©rer</button>
        </div>
        <div id="apiStatus" class="hint"></div>
      </div>
    </div>

    <!-- PRU -->
    <div class="row">
      <div>
        <div class="label">Nombre d‚Äôactions</div>
        <input id="shares" type="number" inputmode="decimal" value="100">
      </div>
      <div>
        <div class="label">Prix moyen d‚Äôachat (PRU)</div>
        <input id="pru" type="number" inputmode="decimal" placeholder="ex: 200">
        <div class="chk">
          <input type="checkbox" id="useCurrentIfNoPRU" style="transform:scale(1.1);">
          <label for="useCurrentIfNoPRU">Pas de PRU ‚Üí utiliser le prix actuel</label>
        </div>
      </div>
    </div>

    <!-- Prix actuel + Dividende -->
    <div class="row">
      <div>
        <div class="label">Prix actuel (optionnel)</div>
        <input id="currentPrice" type="number" inputmode="decimal" placeholder="ex: 215">
        <div class="hint">Affiche rendement actuel et P/L si renseign√©</div>
      </div>
      <div>
        <div class="label">Dividende</div>
        <div class="inline">
          <select id="dMode">
            <option value="amount">Montant</option>
            <option value="percent">%</option>
          </select>
          <input id="dVal" type="number" inputmode="decimal" value="4">
        </div>
        <div class="hint" id="dHint">Ex.: entrez 4 pour 4 ‚Ç¨/kr/$ par action/an.</div>
      </div>
    </div>

    <button class="btn" id="calc">Calculer</button>

    <!-- Carte API -->
    <div class="pill" id="apiCard" style="display:none">
      <div style="margin-bottom:8px;">Prochain dividende <span id="apiTicker" class="badge"></span></div>
      <div class="grid">
        <div class="kpi"><small>Montant par action</small><b id="apiAmount">‚Äî</b></div>
        <div class="kpi"><small>Devise</small><b id="apiCcy">‚Äî</b></div>
        <div class="kpi"><small>Ex-date</small><b id="apiEx">‚Äî</b></div>
        <div class="kpi"><small>Payment date</small><b id="apiPay">‚Äî</b></div>
      </div>
      <div class="hint" id="apiSource"></div>
    </div>

    <!-- KPIs -->
    <div class="pill">
      <div>Rendement sur PRU (yield on cost)</div>
      <div class="yield" id="yieldOnCost">‚Äî</div>
      <div class="hint" id="yocRef"></div>
    </div>

    <div class="grid">
      <div class="kpi"><small>Co√ªt total</small><b id="cost">‚Äî</b></div>
      <div class="kpi"><small>Dividende annuel total</small><b id="annual">‚Äî</b></div>
      <div class="kpi"><small>Dividende mensuel</small><b id="monthly">‚Äî</b></div>
      <div class="kpi"><small>Dividende trimestriel</small><b id="quarterly">‚Äî</b></div>
    </div>

    <div class="pill" id="currentBlock" style="display:none; margin-top:16px;">
      <div>Avec le <b>prix actuel</b></div>
      <div class="grid" style="margin-top:10px;">
        <div class="kpi"><small>Rendement actuel</small><b id="currentYield">‚Äî</b></div>
        <div class="kpi"><small>P/L latent</small><b id="plAmount">‚Äî</b></div>
        <div class="kpi"><small>P/L (%)</small><b id="plPct">‚Äî</b></div>
        <div class="kpi"><small>Valeur de la position</small><b id="mktValue">‚Äî</b></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-outline" id="shareLink">Lien partageable</button>
      <button class="btn-outline" id="clear">R√©initialiser</button>
    </div>
  </div>

  <div class="foot">‚ö†Ô∏è Estimations indicatives. Les dividendes peuvent varier.</div>
</div>

<script>
const $ = id => document.getElementById(id);
const fmtNum = x => isNaN(x)?'‚Äî':new Intl.NumberFormat('fr-FR',{maximumFractionDigits:2}).format(x);
const fmtPct = x => (isNaN(x)||!isFinite(x))?'‚Äî':x.toFixed(2)+' %';

function resolvePRU(pru, cur, useCurIfNo) {
  if (!isNaN(pru) && pru>0) return pru;
  if (useCurIfNo && !isNaN(cur) && cur>0) return cur;
  return NaN;
}
function resolveDPS(mode, val, refPrice){
  if (mode==='amount') return val;
  if (mode==='percent') return (refPrice>0)? (val/100)*refPrice : NaN;
  return NaN;
}

function compute(){
  const s   = parseFloat($('shares').value);
  const pruInput = parseFloat($('pru').value);
  const useCurIfNo = $('useCurrentIfNoPRU').checked;
  const cur = parseFloat($('currentPrice').value);
  const dMode = $('dMode').value;
  const dVal  = parseFloat($('dVal').value);

  const pru = resolvePRU(pruInput, cur, useCurIfNo);
  const refForPercent = !isNaN(cur)&&cur>0 ? cur : pru;
  const dps = resolveDPS(dMode, dVal, refForPercent);

  $('dHint').textContent = dMode==='amount'
    ? "Ex.: entrez 4 pour 4 ‚Ç¨/kr/$ par action/an."
    : "Rendement annuel en %. Si prix actuel saisi, il sert de r√©f√©rence, sinon le PRU.";
  $('yocRef').textContent = isNaN(pru) ? "PRU non d√©fini." : `Calcul bas√© sur PRU = ${fmtNum(pru)}`;

  let cost = NaN, annual = NaN, yoc = NaN;
  if (s>0 && !isNaN(pru)) cost = s*pru;
  if (s>0 && !isNaN(dps)) annual = s*dps;
  if (!isNaN(pru) && !isNaN(dps)) yoc = (dps/pru)*100;

  $('yieldOnCost').textContent = fmtPct(yoc);
  $('cost').textContent = fmtNum(cost);
  $('annual').textContent = fmtNum(annual);
  $('monthly').textContent = fmtNum(annual/12);
  $('quarterly').textContent = fmtNum(annual/4);

  if (!isNaN(cur) && cur>0){
    const mkt = s*cur;
    const plAmt = (!isNaN(cost)? mkt - cost : NaN);
    const plPct = (!isNaN(pru)? ((cur - pru)/pru)*100 : NaN);
    const curYield = (!isNaN(dps)? (dps/cur)*100 : NaN);

    $('currentBlock').style.display = '';
    $('currentYield').textContent = fmtPct(curYield);
    $('plAmount').textContent = fmtNum(plAmt);
    $('plPct').textContent = fmtPct(plPct);
    $('mktValue').textContent = fmtNum(mkt);
  } else {
    $('currentBlock').style.display = 'none';
  }
  saveToHash();
}

// === API dividendes (n√©cessite /api/dividende.js c√¥t√© Vercel) ===
async function fetchDividend() {
  const t = $('ticker').value.trim();
  if (!t) { $('apiStatus').textContent = "Entre un ticker."; return; }
  $('apiStatus').textContent = "‚ü≥ R√©cup√©ration‚Ä¶";
  $('apiCard').style.display = 'none';

  try {
    const r = await fetch(`/api/dividende?ticker=${encodeURIComponent(t)}`);
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || "Erreur API");

    $('apiTicker').textContent = j.ticker || t;
    $('apiAmount').textContent = (j.amount!=null) ? fmtNum(j.amount) : '‚Äî';
    $('apiCcy').textContent = j.currency || '‚Äî';
    $('apiEx').textContent = j.exDate || '‚Äî';
    $('apiPay').textContent = j.paymentDate || '‚Äî';
    $('apiSource').textContent = `Source: ${j.source} ‚Ä¢ ${new Date(j.fetchedAt).toLocaleString()}`;
    $('apiCard').style.display = '';

    if (j.amount != null) { // pr√©remplir le dividende
      $('dMode').value = 'amount';
      $('dVal').value = j.amount;
      $('dHint').textContent = "Montant import√© depuis l'API.";
    }
    $('apiStatus').textContent = "";
  } catch (e) {
    $('apiStatus').textContent = "‚ö†Ô∏è " + e.message;
  }
}

// Th√®me
const root = document.documentElement;
const savedTheme = localStorage.getItem('theme');
if (savedTheme) root.setAttribute('data-theme', savedTheme);
$('themeToggle').onclick = ()=>{
  const isDark = root.getAttribute('data-theme')==='dark';
  root.setAttribute('data-theme', isDark?'':'dark');
  localStorage.setItem('theme', isDark?'':'dark');
};

// PDF
$('printBtn').onclick = ()=> window.print();

// Partage
function saveToHash(){
  const params = new URLSearchParams({
    ticker:$('ticker').value,
    shares:$('shares').value, pru:$('pru').value, useCur:$('useCurrentIfNoPRU').checked?1:0,
    current:$('currentPrice').value, dMode:$('dMode').value, dVal:$('dVal').value
  });
  history.replaceState(null,'','#'+params.toString());
}
function loadFromHash(){
  if(location.hash.length>1){
    const p = new URLSearchParams(location.hash.slice(1));
    if(p.get('ticker')) $('ticker').value = p.get('ticker');
    if(p.get('shares')) $('shares').value = p.get('shares');
    if(p.get('pru')) $('pru').value = p.get('pru');
    if(p.get('useCur')) $('useCurrentIfNoPRU').checked = p.get('useCur')==='1';
    if(p.get('current')) $('currentPrice').value = p.get('current');
    if(p.get('dMode')) $('dMode').value = p.get('dMode');
    if(p.get('dVal')) $('dVal').value = p.get('dVal');
  }
}
$('shareLink').onclick = ()=>{
  saveToHash();
  navigator.clipboard.writeText(location.href).then(()=>{
    $('shareLink').textContent='Lien copi√© ‚úÖ';
    setTimeout(()=>$('shareLink').textContent='Lien partageable',1200);
  });
};
$('clear').onclick = ()=>{
  ['ticker','shares','pru','currentPrice','dVal'].forEach(id => $(id).value='');
  $('dMode').value='amount'; $('useCurrentIfNoPRU').checked=false;
  $('apiCard').style.display = 'none';
  $('apiStatus').textContent = '';
  compute();
};

// Events
$('calc').addEventListener('click', compute);
$('fetchDiv').addEventListener('click', fetchDividend);
['ticker','shares','pru','currentPrice','dVal','dMode','useCurrentIfNoPRU']
  .forEach(id => $(id).addEventListener('change', ()=>{}));

loadFromHash();
compute();
</script>
</body>
</html>
